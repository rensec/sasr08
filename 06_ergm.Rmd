
# Exponential Random Graphs Modeling



```{r  message=F, warning =FALSE}

library(network)
library(igraph)
library(intergraph)
library(sna)
library(ergm)
library(tidyverse) 


```

## Data preparation

We'll work with the same single class ("12b") from the Knecht data as before. To keep things very concise here, we simply load an `igraph` network object that we've saved to disk before.


```{r}
load("classnet.rdata")
summary(classnet)
```

However, for exponential random graph modeling, we'll actually need network objects from the `network` class (that is, as generated by the `network` package). For this, we'll use the `intergraph` package, already loaded above. Unfortunately, `network` does not handle factor variables, so we first need to convert 'sex' to a numeric variable.

```{r}

V(classnet)$sex <-as.numeric(V(classnet)$sex)
g <- asNetwork(classnet)
g
```

The alternative approach would be to load the original data set, filter out the class, prepare the data as an edge list and node list as we've done before, and then import it directly into a `network` object using one of the `as.network...()` function from the `network` package. 

```{r}
gplot(g,  vertex.col=g %v% "sex"*2)
```
Looks like we have some gender homophily going on here, as well as a lot of reciprocity! With ERGM, we can test this statistically.  

# Model estimation

Now let's estimate a simple model. First we test the hypothesis that ties are likely to be reciprocated. In this case we add, besides the "edges"  term, 

```{r}
M1.g<-ergm(g ~ edges +  mutual )

summary(M1.g)
```
Indeed, we find a positive and significant effect for the number of reciprocated ties. 

Now let's add the homophily effect (as well as a gender differential effect):

```{r, message = FALSE, warning = FALSE}
M2.g<-ergm(g ~ edges + mutual +  nodefactor("sex", levels = 2) + nodematch("sex" ))

summary(M2.g)


```
Indeed, we find a positive effect of gender homophily. 

Finally, let's look at goodness of fit: 

```{r, warning=FALSE, message=FALSE}
M2.g.gof <- gof(M2.g)
M2.g.gof
```
This looks OK for the model statistics, but less so for the for network statistics *not* in the model. Let's have a closer look at those:

```{r}
plot(M2.g.gof)
```

Indeed, some of these are quite off, indicating that we might want to include some other effects in the model. Indeed, for directed networks, it is common to include at least somethign related to degree, reciprocity, and something related to triadic closure. The exact choice of effects is not trivial though and may lead to compuational complications, so we leave it at this for now. 

For further introductions to ERGM, we suggest [this  tutorial](https://statnet.org/workshop-ergm/ergm_tutorial.html#1_Statistical_network_modeling_with_ERGMs)  by the Statnet team and [this tutorial](https://inarwhal.github.io/NetworkAnalysisR-book/ch13-Cross-Sectional-Network-Models-ERGM-R.html) by Rawlings et al. The latter in particular has an informative illustration of the inclusion of triadic effects and the computational issues involved. Also helpful is [this short list](https://statnet.org/nme/d2-ergmterms.html) of common ERGM terms. A longer list is [here](https://search.r-project.org/CRAN/refmans/ergm/html/ergmTerm.html). 




