
# Exponential Random Graphs Modeling



```{r}

library(haven) #For reading Stata files
library(network)
library(igraph)
library(intergraph)
library(sna)
library(ergm)
library(tidyverse) 


```

## Data preparation

We'll work with the same single class ("12b") from the Knecht data as before. To keep things very consise here, we simply load an `igraph` network object that we've saved to disk before.


```{r}
load("classnet.rdata")
summary(classnet)
```

However, for exponential random graph modeling, we'll actually need network objects from the `network` class (that is, as generated by the `network` package). For this, we'll use the `intergraph` package, already loaded above. Unfortunately, `network` does not handle factor variables, so we first need to convert 'sex' to a numeric variable.

```{r}

V(classnet)$sex <-as.numeric(V(classnet)$sex)
g <- asNetwork(classnet)
g
```

The alternative approach would be to load the original data set, filter out the class, prepare the data as an edge list and node list as we've done before, and then import it directly into a `network` object using one of the `as.network...()` function from the `network` package. 

```{r}
gplot(g,  vertex.col=g %v% "sex"*2)
```
Looks like we have some gender homophily going on here, as well as a lot of reciprocity! With ERGM, we can test this statistically.  

# Model estimation

Now let's estimate a simple model. First we test the hypothesis that ties are likely to be reciprocated. In this case we add, besides the "edges"  term, 

```{r}
M1.g<-ergm(g ~ edges +  mutual )

summary(M1.g)
```
Indeed, we find a positive and significant effect for the number of reciprocated ties. 

Now let's add the homophily effect (as well as a gender differential effect):

```{r, message = FALSE, warning = FALSE}
M2.g<-ergm(g ~ edges + mutual +  nodefactor("sex", levels = 2) + nodematch("sex" ))

summary(M2.g)


```
Indeed, we find a positive effect of gender homophily. 

Finally, let's look at goodness of fit: 

```{r, warning=FALSE, message=FALSE}
M2.g.gof <- gof(M2.g)
M2.g.gof
```
This looks OK for the model statistics, but less so for the for network statistics *not* in the model. Let's have a closer look at those:

```{r}
plot(M2.g.gof)
```

Indeed, some of these are quite off, indicating that we might want to include some other effects in the model. Indeed, for directed networks, it is common to include at least indegree-, outdegree-, reciprocity, and something related to triadic closure. The exact choice of effects is not trivial though, so we leave it at this for now. 

